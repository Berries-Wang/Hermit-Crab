- [Node(节点)](#node节点)
  - [节点是什么](#节点是什么)
  - [Node示例图](#node示例图)
  - [节点管理](#节点管理)
  - [控制面到节点通信](#控制面到节点通信)
    - [节点到控制面](#节点到控制面)
    - [控制面(apiserver)到节点](#控制面apiserver到节点)
      - [apiserver到kubelet](#apiserver到kubelet)
      - [apiserver到节点、Pod、服务](#apiserver到节点pod服务)
  - [参考资料](#参考资料)
  
 -------------

# Node(节点)
## 节点是什么
&nbsp;&nbsp;Kubernetes通过将容器放入在节点（Node）上运行的Pod中来执行你的工作负载。节点可以是一个虚拟机或者物理机，这取决于所在的集群配置。每个节点包含运行Pods所需要的服务；这些节点由控制面负责管理。
  + 每个 Node（节点）都由 master 管理。一个 Node（节点）可以有多个Pod（容器组），kubernetes master 会根据每个 Node（节点）上可用资源的情况，自动调度 Pod（容器组）到最佳的 Node（节点）上。(可参照ReadMe.md来分析)

&nbsp;&nbsp;通常集群中会有若干个节点，而在一个学习或者资源受限的环境中，你的集群也可能只有一个节点。

&nbsp;&nbsp;节点上的组件包括: kubelet 、 容器运行时 、 kube-proxy

## Node示例图
<img src="../pics/module_03_nodes.38f0ef71.svg"/>

  - 如上图，一个Node上含有4个Pod（容器组）

##  节点管理
&nbsp;&nbsp;详见文档:
1. kuboard:[https://www.kuboard.cn/learning/k8s-bg/architecture/nodes.html](https://www.kuboard.cn/learning/k8s-bg/architecture/nodes.html)
2. 官网:[https://kubernetes.io/zh/docs/concepts/architecture/nodes/](https://kubernetes.io/zh/docs/concepts/architecture/nodes/)

## 控制面到节点通信
<img src="../pics/components-of-kubernetes.svg">

### 节点到控制面
&nbsp;&nbsp;所有从集群（或所运行的Pods）发出的API调用都终止于apiserver。其他控制面组件都没有被设计为可暴露远程服务。apiserver被配置为在一个安全的HTTPS端口上监听远程连接请求，并启动一种或者多种形式的客户端身份认证机制。一种或者多种客户端鉴权机制应该被启用，特别是在允许使用匿名请求或服务账号令牌的时候。

&nbsp;&nbsp;应该使用集群的公共根证书开通节点，这样它们就能够基于有效的客户端凭据安全地连接 apiserver。 一种好的方法是以客户端证书的形式将客户端凭据提供给 kubelet。 请查看[ kubelet TLS 启动引导](https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)<sup>待分析</sup>以了解如何自动提供 kubelet 客户端证书。

&nbsp;&nbsp;想要连接到apiserver的Pod可以使用服务账号安全的进行连接。当Pod被实例化的时，Kubernetes自动把公共根证书和一个有效的持有者令牌注入到Pod里。Kubernetes服务（位于default命名空间中）配置了一个虚拟IP地址，用于（通过kube-proxy）转发请求到apiserver的HTTPS末端。

&nbsp;&nbsp;控制面板组件也通过安全端口与集群apiserver通信。

### 控制面(apiserver)到节点
&nbsp;&nbsp;从控制面（apiserver)到节点有两种通信路径。
1. 第一种是从apiserver到集群中运行在每个节点上的kubelet进程
2. 第二种是从apiserver通过他的代理功能连接到任何节点、pod、服务

#### apiserver到kubelet
&nbsp;&nbsp;apiserver到kebelet的连接用于
1. 获取pod日志
2. 挂接（通过 kubectl）到运行中的 Pod,如kubectl exec -it
3. 提供 kubelet 的端口转发功能。（kubectl port-forward）
  
&nbsp;&nbsp;这些连接终止于 kubelet 的 HTTPS 末端。 默认情况下，apiserver 不检查 kubelet 的服务证书。这使得此类连接容易受到中间人攻击， 在非受信网络或公开网络上运行也是**不安全的**。为了对这个连接进行认证，使用 --kubelet-certificate-authority 标志给 apiserver 提供一个根证书包，用于 kubelet 的服务证书。如果无法实现这点，又要求避免在非受信网络或公共网络上进行连接，可在 apiserver 和 kubelet 之间使用 SSH 隧道。最后，应该启用 kubelet 用户认证和/或鉴权 来保护 kubelet API。
   - 即apiserver到kubelet的网络安全性问题。

#### apiserver到节点、Pod、服务
&nbsp;&nbsp;从 apiserver 到节点、Pod 或服务的连接默认为纯 HTTP 方式，因此既没有认证，也没有加密。 这些连接可通过给 API URL 中的节点、Pod 或服务名称添加前缀 https: 来运行在安全的 HTTPS 连接上。 不过这些连接既不会验证 HTTPS 末端提供的证书，也不会提供客户端证书。 因此，虽然连接是加密的，仍无法提供任何完整性保证。 这些连接 目前还不能安全地 在非受信网络或公共网络上运行。




----------------------

## 参考资料
1. 官方文档:[https://kubernetes.io/zh/docs/concepts/architecture/nodes/](https://kubernetes.io/zh/docs/concepts/architecture/nodes/)
2. kuboard:[https://www.kuboard.cn/learning/k8s-basics/explore.html#node-%E8%8A%82%E7%82%B9](https://www.kuboard.cn/learning/k8s-basics/explore.html#node-%E8%8A%82%E7%82%B9)